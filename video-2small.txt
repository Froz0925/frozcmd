Froz Video recode script (video-2small.cmd)
-------------------------------------------

Перекодирование видеофайлов с телефонов и фотокамер для домашнего видеоархива
в уменьшенный размер файла с высоким качеством.

Поддерживаемые кодеки (HEVC - меньше размер, H.264 - выше совместимость):
   - NVIDIA GPU: hevc_nvenc (рекомендуемый) и h264_nvenc.
                 Требуется GeForce GTX 950+ (Maxwell 2nd Gen GM20x) (2014+) и драйвер Nvidia v.570+.
   - AMD GPU:    hevc_amf и h264_amf - Radeon RX 400 / R9 300 серии и новее (2015+)
   -             Требуется драйвер AMD Adrenalin Edition (не Microsoft)
   - Intel GPU:  hevc_qsv и h264_qsv - Intel Skylake+ (2015+), драйвер Intel HD + Media Feature Pack
   - CPU:        libx265 - очень медленно, libx264 - медленно

Как использовать:
   - Настройте параметры в начале скрипта (блок ЮЗЕР) в редакторе с поддержкой OEM-кодировки,
     например "Блокнот" со шрифтом Terminal (OEM/DOS с кириллицей).
   - Перетащите видеофайлы на скрипт - обработка начнётся автоматически.
   - Готовые файлы сохраняются в ту же папку, с суффиксом _sm (настраивается).
   - Логи пишутся в подпапку logs.

Режимы масштабирования:
   - SCALE=1: уменьшить до 720p, если высота > 720 (включая повёрнутые).
   - SCALE= (пусто): уменьшить до 1080p только если видео физически повёрнуто (портрет)
     и высота > 1080 (стандартный FullHD монитор).
     Это позволяет сохранить FullHD для ландшафтных видео,
     но уменьшить портретные чтобы не возникали высоты кадра типа 1920 или 1280.

Качество:
   - Можно задать CRF вручную: меньше значение = выше качество.
     Рекомендуется: nvenc: 18-30, amf/qsv: 1-51, libx264: 18-24, libx265: 24-30.
   - Если CRF не задан - для nvenc включается VBR-HQ с multipass - качество выше,
     но ниже скорость: 720p: битрейт ~2.5 Мбит, 1080p: ~4.5 Мбит.

Аудио:
   - По умолчанию: сжимается до Opus 128k (меньше размер, высокое качество).
   - Для отключения перекодировки: закомментируйте строку AUDIO_ARGS через :: .

Поворот:
   - Если в MP4/MOV есть тег поворота - он обрабатывается автоматически.
   - При ручной установке ROTATION=-90 или 90 - используется фильтр transpose (для nvenc/amf) или metadata (для qsv).
   - Важно: *qsv не поддерживает фильтр поворота - используется тег Rotate в MP4, который будет перенесён в итоговый файл.
   - Конфликт: если нужно и поворот (qsv), и full-range - скрипт предупредит: full-range приоритетнее и пропустит файл.

Цвет:
   - Если найдена метка JPEG Full Range (хотя по факту видео всегда в Limited Range) - 
     в MKV через mkvpropedit добавляется метка colour-range чтобы плееры отображали цвета как в исходнике.
     При этом контейнер меняется на MKV, так как MP4 не поддерживает эту метку.

Частота кадров:
   - Плавающий FPS (VFR) автоматически преобразуется в постоянный (CFR).
   - Определяется максимальный FPS, и устанавливается ближайший стандартный: 25, 30, 50, 60.
   - Для чересстрочного видео (50i/60i) - деинтерлейсинг и преобразование в 50p/60p.

Формат и метаданные:
   - Контейнер: MKV (по умолчанию), MP4 - если нужна совместимость с qsv/amf.
   - Языки дорожек устанавливается в "rus" кроме видеодорожки в MP4 - там остаётся исходный язык
     (ffmpeg некорректно обрабатывает язык видео в MP4 при перекодировании)
   - Удаляются устаревшие теги битрейта и размера, если они найдены,
     так как после перекодирования их значения неактуальны.

Особенности:
   - Примерное время кодирования рассчитывается по заданной вами скорости GPU/CPU.
   - Поддерживаются все распространённые форматы: MP4, MOV, AVI, MKV и др.
---



Краткое описание:

video-2small.cmd - перекодирует видео с телефонов в архивный формат с уменьшенным размером и высоким качеством.
Автоматически обрабатывает поворот, VFR, цвет, масштабирование и метаданные.
Поддерживает аппаратное ускорение (NVENC, AMF, QSV) и CPU.