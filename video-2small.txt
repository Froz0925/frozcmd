Froz Video recode script (video-2small.cmd)
-------------------------------------------

Краткое описание:
video-2small.cmd - перекодирует видео с телефонов в архивный формат с уменьшенным размером и высоким качеством.
Автоматически обрабатывает поворот, VFR -> CFR, цвет (Full Range), масштабирование и метаданные.
Поддерживает аппаратное ускорение (NVENC, AMF, QSV) и CPU.


Полное описание:
Перекодирование видеофайлов с телефонов и фотокамер для домашнего видеоархива
в уменьшенный размер файла с высоким качеством.

Поддерживаемые кодеки (HEVC - меньше размер, H.264 - выше совместимость):
   - NVIDIA GPU: hevc_nvenc (рекомендуемый) и h264_nvenc.
                 Требуется GeForce GTX 950+ (Maxwell 2nd Gen GM20x) (2014+) и драйвер Nvidia v.570+.
   - AMD GPU:    hevc_amf и h264_amf - Radeon RX 400 / R9 300 серии и новее (2015+)
   -             Требуется драйвер AMD Adrenalin Edition (не Microsoft)
   - Intel GPU:  hevc_qsv и h264_qsv - Intel Skylake+ (2015+), драйвер Intel HD + Media Feature Pack
   - CPU:        libx265 - очень медленно, libx264 - медленно

Как использовать:
   - При необходимости измените настройки в файле video-2small.ini
     (если его нет - он будет создан автоматически)
     любым редактором для TXT-файлов UTF-8, например Блокнотом.
   - Перетащите видеофайлы на скрипт.
   - Готовые файлы сохраняются в ту же папку, с суффиксом _sm (настраивается в ini).
   - Логи пишутся в подпапку logs.

Цвет:
   - Если найдена метка JPEG Full Range (хотя по факту видео всегда в Limited Range) - 
     в MKV через mkvpropedit добавляется метка colour-range чтобы плееры отображали цвета как в исходнике.
     При этом контейнер меняется на MKV, так как MP4 не поддерживает эту метку.

Поворот:
   - Если в MP4/MOV есть тег поворота - он обрабатывается автоматически.
   - При ручной установке ROTATION -90 или 90 - к тегу поворота из файла добавляется фильтр transpose
   - Важно: кодеки *qsv не поддерживают transpose - User-Rotation будет проигнорирован.

Масштабирование:
   - SCALE=1: уменьшить до 720p, если итоговая высота кадра (после поворота) > 720.
   - SCALE= (пусто): уменьшить до 1080p (высота стандартного FullHD монитора),
     если итоговая высота кадра (после поворота) > 1080.
     Это позволяет сохранить FullHD для ландшафтных видео,
     но уменьшить портретные с большими высотами (например, 1920 или 1280).

Частота кадров:
   - Плавающий FPS (VFR) автоматически преобразуется в постоянный (CFR).
   - Определяется максимальный FPS, и устанавливается ближайший стандартный: 25, 30, 50, 60.
   - Для чересстрочного видео (50i/60i) - применяется деинтерлейсинг и преобразование в 50p/60p
     чтобы сохранить плавность видео. Но можно задать FPS принудительно,
     например если нужно не 50i -> 50p, а 50i -> 25p.

Качество:
   - Можно задать CRF вручную: меньше значение = выше качество.
     Рекомендуется: nvenc: 23-30, amf/qsv: 20-28, libx264: 22-26, libx265: 26-28.
   - Если CRF не задан - для nvenc включается VBR-HQ с multipass - качество выше,
     но ниже скорость: 720p: средний битрейт ~2 Мбит, 1080p: ~4 Мбит.

Аудио:
   - По умолчанию: если аудио не кодек OPUS - сжимается до Opus 128k (меньше размер, высокое качество).
   - Для отключения перекодировки - удалить ключ в ini.

Формат и метаданные:
   - Контейнеры: MKV (по умолчанию) и MP4.
   - Языки дорожек устанавливается в "rus" кроме видеодорожки в MP4 - там остаётся исходный язык
     (ffmpeg некорректно обрабатывает язык видео в MP4 при перекодировании)
   - Удаляются устаревшие теги битрейта и размера, если они найдены,
     так как после перекодирования их значения неактуальны.

Особенности:
   - Примерное время кодирования рассчитывается на основе длительности видео
     и заданной вами скорости кодирования (SPEED_*).
     Значения взяты опытным путём: (секунд кодирования / секунд видео) x 100.
   - Поддерживаются все распространённые форматы: MP4, MOV, AVI, MKV и др.
